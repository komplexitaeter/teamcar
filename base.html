<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team-as-a-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/style.css">
    <script src="script.js"></script>
</head>
<body class="flex-display">

<!-- Brand Icon -->
<a href="https://komplexitaeter.de" target="_blank">
    <img id="brand" src="src/brand.png" alt="Komplexitäter" />
</a>

<!-- Feedback Icon -->
<div class="feedback-icon" onclick="window.open('https://feedback.komplexitaeter.de?context=teamcar', '_blank')">
    <i class="fas fa-heart"></i>
</div>

<p class="instruction_base">Wähle deinen Namen aus und ziehe ihn in den rechten Bereich.</p>

<div class="container">
    <div class="left-side">
        <div id="member-list" class="names names-big grab-cursor name-selection">
            <!-- Dynamisch erstellte Mitglieder werden hier eingefügt -->
        </div>

        <!-- Buttons Container -->
        <div class="share-container">
            <button class="share-btn" onclick="copyURL()">
                <i class="fas fa-copy"></i>
                Link zu dieser Seite teilen
            </button>

            <!-- Button zur Auswertung -->
            <button id="evaluation-btn" class="evaluation-btn" disabled>
                Zur Auswertung<br/> (min. 3 Votes notwendig)
            </button>
        </div>

        <!-- Hinweis Sprechblase -->
        <div id="tooltip" class="tooltip">
            <p>Teile diese Seite mit deinem Team, damit alle loslegen können</p>
        </div>
    </div>
    <div class="dropzone-container">
        <div class="dropzone" id="dropzone">
            <p>Das bin ich und ich will loslegen...</p>
        </div>
    </div>
</div>

<!-- Snackbar für Rückmeldung -->
<div id="snackbar" class="snackbar">Link wurde kopiert!</div>

<script>
    let draggedItem = null;
    const dropzone = document.getElementById('dropzone');
    const evaluationBtn = document.getElementById('evaluation-btn');
    let lastJSON =null;

    // Funktion zum Abrufen und Aktualisieren der Mitglieder
    async function fetchAndUpdateMembers(onLoad=false) {
        try {
            const teamKey = getURLParameter('t'); // Nehme den team_key aus der URL
            const response = await fetch(`get_members.php?t=${teamKey}`);
            const data = await response.json();

            let readyCount = 0;

            lastJSON = data;

            if (data.status === 'success') {

                if (onLoad) {
                    if (data.language_code.toLowerCase() === 'en') {
                        translateElements('base', 'en');
                    } else {
                        translateElements('base', 'de');
                    }
                }


                const memberList = document.getElementById('member-list');
                data.members.forEach(member => {

                    if (member.status === 2) readyCount++;

                    const memberDiv = document.getElementById(member.key);

                    // Wenn das Mitglied noch nicht existiert, erstellen wir es
                    if (!memberDiv) {
                        createMemberDiv(member);
                    } else {
                        // Wenn das Mitglied existiert, prüfen wir, ob das Icon und der drag-Status korrekt sind
                        updateMemberDiv(memberDiv, member);
                    }
                });

                if (readyCount>=3) evaluationBtn.disabled = false;
            }
        } catch (error) {
            console.error('Fehler beim Abrufen der Mitglieder:', error);
        }
    }

    // Funktion zur Erstellung eines neuen Mitglied-Divs
    function createMemberDiv(member) {
        const memberList = document.getElementById('member-list');
        const memberDiv = document.createElement('div');
        memberDiv.id = member.key; // Setze die ID auf den member.key
        memberDiv.classList.add('name');

        const span = document.createElement('span');
        span.textContent = member.name;

        const icon = document.createElement('i');
        icon.classList.add('fas');
        memberDiv.appendChild(span);
        memberDiv.appendChild(icon);

        updateMemberDiv(memberDiv, member); // Setze den Status des Members

        memberList.appendChild(memberDiv);
    }

    // Funktion zur Aktualisierung des Status eines Mitglieds
    function updateMemberDiv(memberDiv, member) {
        const icon = memberDiv.querySelector('i');

        // Aktualisiere das Icon und den dragable Status basierend auf dem Member-Status
        if (member.status === 0) {
            icon.classList.remove('fa-cog', 'fa-check');
            icon.classList.add('fa-grip-lines');
            memberDiv.setAttribute('draggable', 'true');
        } else if (member.status === 1) {
            icon.classList.remove('fa-grip-lines', 'fa-check');
            icon.classList.add('fa-cog');
            memberDiv.setAttribute('draggable', 'false');
        } else if (member.status === 2) {
            icon.classList.remove('fa-grip-lines', 'fa-cog');
            icon.classList.add('fa-check');
            memberDiv.setAttribute('draggable', 'false');
        }
    }

    // Starte die Aktualisierung der Mitgliederliste alle 10 Sekunden
    setInterval(fetchAndUpdateMembers, 10000);

    // Entfernt einen Parameter aus der URL
    function removeURLParameter(parameter) {
        const url = new URL(window.location.href);
        url.searchParams.delete(parameter);
        window.history.replaceState(null, '', url);
    }

    document.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('name') && !e.target.classList.contains('no-drag')) {
            draggedItem = e.target;
            e.dataTransfer.setData('text/plain', e.target.innerText);
            e.target.style.border = '1px solid black';
            e.target.style.opacity = '0.6';
        }
    });

    document.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('name')) {
            e.target.style.border = '1px solid #ccc';
            e.target.style.opacity = '1';
        }
    });

    dropzone.addEventListener('dragover', function(e) {
        if (draggedItem) {
            e.preventDefault();
            dropzone.classList.add('dragover');
        }
    });

    dropzone.addEventListener('dragleave', function(e) {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        if (draggedItem) {
            const key = draggedItem.id;
            dropzone.classList.remove('dragover');

            // Suche im lastJSON nach dem Member mit dem Key
            const member = lastJSON.members.find(member => member.key === key);

            // Überprüfen, ob das Mitglied existiert und der Status 0 ist
            if (member && member.status === 0) {

                // Weiterleitung zur neuen Seite mit dem Namen als Parameter
                window.location.href = `assignment.html?key=${encodeURIComponent(key)}`;
            } else {
                // Das Drop-Event nicht verhindern (damit das Element zurückspringt)
                draggedItem = null;  // Setze draggedItem zurück
            }
        }
    });


    // Funktion zum Kopieren der URL in die Zwischenablage ohne URL-Parameter
    function copyURL() {
        const url = new URL(window.location.href);
        url.searchParams.delete('show_hint'); // Entfernt den Parameter aus der kopierten URL
        navigator.clipboard.writeText(url.href).then(() => {
            showSnackbar();
        }).catch(err => {
            console.error('Fehler beim Kopieren der URL: ', err);
        });
    }

    // Funktion zur Anzeige der Snackbar
    function showSnackbar() {
        const snackbar = document.getElementById('snackbar');
        snackbar.classList.add('show');
        setTimeout(() => {
            snackbar.classList.remove('show');
        }, 3000);
    }

    // Tooltip basierend auf URL-Parameter anzeigen
    window.onload = function() {
        const showHint = getURLParameter('show_hint');
        if (showHint === '1') {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.add('show');

            // Sprechblase nach 5 Sekunden ausblenden
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 5000);

            // Entfernt den 'show_hint'-Parameter aus der URL
            removeURLParameter('show_hint');
        }

    };

    // Event-Listener für den Finish-Button zur Weiterleitung
    evaluationBtn.addEventListener('click', function() {
        if (!evaluationBtn.disabled) {
            window.location.href = 'summary.html'; // Weiterleitung zur Launch-Seite
        }
    });

    fetchAndUpdateMembers(true);

</script>
</body>
</html>

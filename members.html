<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team-as-a-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/style.css">
    <script src="script.js"></script>
</head>
<body class="flex-display">

<!-- Brand Icon -->
<a href="https://komplexitaeter.de" target="_blank">
    <img id="brand" src="src/brand.png" alt="Komplexitäter" />
</a>

<!-- Feedback Icon -->
<div class="feedback-icon" onclick="window.open('https://feedback.komplexitaeter.de?context=teamcar', '_blank')">
    <i class="fas fa-heart"></i>
</div>


<div class="container vertical-center">
    <!-- Überschrift -->
    <h1 id="members_header" class="team-heading"></h1>

    <!-- Eingabefeld für Teammitglied hinzufügen -->
    <div class="input-container">
        <input type="text" id="member-name-input" placeholder="" />
    </div>

    <!-- Liste der Teammitglieder -->
    <div id="team-members" class="names names-big name-selection">
        <!-- Dynamisch hinzugefügte Teammitglieder erscheinen hier -->
    </div>

    <!-- Button zur Bestätigung (unten zentriert) -->
    <button id="complete-team-btn" class="evaluation-btn fixed-bottom" disabled>
        Team komplett<br/> (min. 3 Mitglieder erforderlich)
    </button>

    <!-- Statisch platzierte Snackbar -->
    <div id="snackbar" class="snackbar"></div>
</div>

<script>
    const memberNameInput = document.getElementById('member-name-input');
    const teamMembersContainer = document.getElementById('team-members');
    const completeTeamBtn = document.getElementById('complete-team-btn');
    const snackbar = document.getElementById('snackbar');

    if (getURLParameter('lang').toLowerCase() === 'en') {
        translateElements('members', 'en');
    } else {
        translateElements('members', 'de');
    }

    let teamMembers = [];

    // Funktion zum Überprüfen, ob der Button aktiviert werden soll
    function checkCompleteTeamButton() {
        if (teamMembers.length >= 3) {
            completeTeamBtn.disabled = false;
        } else {
            completeTeamBtn.disabled = true;
        }
    }

    // Funktion zum Einblenden der Snackbar
    function showSnackbar() {
        snackbar.classList.add('show');

        // Entferne die Snackbar nach 3 Sekunden
        setTimeout(() => {
            snackbar.classList.remove('show');
        }, 3000);
    }

    // Funktion zum Hinzufügen eines neuen Teammitglieds
    function addMember() {
        const memberName = memberNameInput.value.trim();

        // Überprüfe, ob das Eingabefeld leer ist oder der Name schon vorhanden ist
        if (memberName === '' || teamMembers.includes(memberName)) {
            // Zeige die Snackbar an
            showSnackbar();

            // Schüttel-Effekt hinzufügen
            memberNameInput.classList.remove('shake'); // Entferne zuerst die Klasse, um Neustart zu ermöglichen
            void memberNameInput.offsetWidth; // Forciere ein Reflow, damit die Klasse wieder hinzugefügt wird
            memberNameInput.classList.add('shake');

            // Den Fokus sicherstellen
            memberNameInput.focus();

            // Entferne die Schüttel-Klasse nach der Animation
            setTimeout(() => {
                memberNameInput.classList.remove('shake');
            }, 500); // Dauer der Animation ist 0.5s

            return;
        }

        // Neues Mitglied zur Liste hinzufügen
        teamMembers.push(memberName);

        // Erstelle das neue Div für das Teammitglied
        const memberDiv = document.createElement('div');
        memberDiv.classList.add('name');
        memberDiv.innerHTML = `
        <span>${memberName}</span>
        <i class="fas fa-trash" onclick="removeMember('${memberName}')"></i>
    `;

        // Füge das neue Mitglieds-Div dem Container hinzu
        teamMembersContainer.appendChild(memberDiv);

        // Leere das Eingabefeld
        memberNameInput.value = '';

        // Überprüfe, ob der Button aktiviert werden soll
        checkCompleteTeamButton();
    }

    // Funktion zum Entfernen eines Teammitglieds
    function removeMember(memberName) {
        // Entferne das Mitglied aus dem Array
        teamMembers = teamMembers.filter(member => member !== memberName);

        // Entferne das entsprechende Div
        const memberDiv = Array.from(teamMembersContainer.children).find(
            div => div.querySelector('span').innerText === memberName
        );
        if (memberDiv) {
            memberDiv.remove();
        }

        // Überprüfe, ob der Button aktiviert werden soll
        checkCompleteTeamButton();
    }

    // Event Listener für das Hinzufügen eines Teammitglieds bei Enter-Taste
    memberNameInput.addEventListener('keyup', (event) => {
        if (event.key === 'Enter') {
            addMember();
        }
    });

    // Funktion zum Entfernen aller Teammitglieder
    function removeAllMembers() {
        // Leere das lokale Array
        teamMembers = [];

        // Entferne alle Mitglied-Divs aus dem DOM
        while (teamMembersContainer.firstChild) {
            teamMembersContainer.removeChild(teamMembersContainer.firstChild);
        }

        // Überprüfe, ob der Button deaktiviert werden soll
        checkCompleteTeamButton();
    }

    // Funktion zum Senden der Teamdaten an den Server
    async function sendTeamData(members) {
        try {
            // Erstelle das Objekt mit den Daten
            const data = {
                members: members,
                lang: getURLParameter('lang') || 'en'
            };

            // Sende die Daten als JSON
            const response = await fetch('create_team.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',  // JSON als Inhaltstyp festlegen
                },
                body: JSON.stringify(data)  // JSON-Objekt als String senden
            });

            const result = await response.json();

            if (result.status === 'success') {
                // Entferne alle Mitglieder aus dem Array und dem DOM, bevor weitergeleitet wird
                removeAllMembers();

                // Weiterleitung zur base.html Seite mit der Team-ID
                window.location.href = `base.html?t=${result.team_id}`;
            } else {
                console.error('Error:', result.message);
                alert('Es gab einen Fehler beim Anlegen des Teams.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Es gab einen Fehler bei der Anfrage.');
        }
    }

    // Event Listener for "Team komplett" button
    completeTeamBtn.addEventListener('click', () => {
        if (teamMembers.length >= 3) {
            // Send the team members to the server
            sendTeamData(teamMembers);
        }
    });

    memberNameInput.focus();
</script>
</body>
</html>

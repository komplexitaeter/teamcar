<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team-as-a-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles/style.css">
    <script src="script.js"></script>
</head>
<body>
<p id="summary-instruction" class="instruction"></p>

<!-- Brand Icon -->
<a href="https://komplexitaeter.de" target="_blank">
    <img id="brand" src="src/brand.png" alt="Komplexitäter" />
</a>

<!-- Feedback Icon -->
<div class="feedback-icon" onclick="window.open('https://feedback.komplexitaeter.de?context=teamcar', '_blank')">
    <i class="fas fa-heart"></i>
</div>


<!-- Info Icon -->
<div class="info-icon">
    <i class="fas fa-info-circle"></i>
</div>

<!-- Info Overlay -->
<div class="info-overlay">
    <div class="legend-item">
        <span class="legend-icon-clamp"></span>
        <span id="legend-clamp"></span>
    </div>
    <div class="legend-item">
        <span class="legend-icon-dash"></span>
        <span id="legend-dash-line"></span>
    </div>
</div>



<div class="container">

    <div id="overlay">
        <div id="overlay-content">
            <div id="overlay-message">
                Die Auswertung wird angezeigt, sobald mindestens 3 Teammitglieder fertig sind.<br/><br/>[DEMO-MODE: warte ein paar Sekunden].
            </div>
            <div class="spinner"></div>
        </div>
    </div>


    <!-- Statische Namen-Liste ohne Drag & Drop -->
    <div id="names-available" class="names names-small name-selection">
        <! Dynamic Content comes here -->

        <!-- Der "Zurück"-Button -->
        <button id="backButton">Zurück</button>
    </div>

    <!-- Rollen-Zuordnungen -->
    <div class="roles">
        <!-- Rollenliste -->
        <div class="role">
            <i class="fas fa-chair"></i>
            <div class="role-header">
                <span id="title-backseat" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="BACKSEAT" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-cogs"></i>
            <div class="role-header">
                <span id="title-engine" class="role-title">Motor</span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="ENGINE" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-map-signs"></i>
            <div class="role-header">
                <span id="title-nav" class="role-title">Navi</span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="NAV" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-circle-notch"></i>
            <div class="role-header">
                <span id="title-steering-wheel" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="STEERING-WHEEL" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-lightbulb"></i>
            <div class="role-header">
                <span id="title-headlights" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="HEADLIGHTS" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-hand-paper"></i>
            <div class="role-header">
                <span id="title-break" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="BREAK" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-bullhorn"></i>
            <div class="role-header">
                <span id="title-horn" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="HORN" class="assigned-names"></div>
        </div>
        <div class="role">
            <i class="fas fa-utensils"></i>
            <div class="role-header">
                <span id="title-lunchbox" class="role-title"></span>
                <span class="role-description"></span>
            </div>
            <div data-role-key="LUNCHBOX" class="assigned-names"></div>
        </div>
    </div>
</div>








<script>

    const teamKey = new URLSearchParams(window.location.search).get('t');
    const namesAvailableDiv = document.getElementById('names-available');

    // Funktion zum Hinzufügen der Hover-Effekte
    function addHoverEvents(element) {
        element.addEventListener('mouseover', function () {
            const name = element.getAttribute('data-name');
            highlightNameElements(name);
        });

        element.addEventListener('mouseout', function () {
            removeHighlight();
        });
    }

    async function updateAssignments() {
        const teamKey = new URLSearchParams(window.location.search).get('t');  // Hol den Team-Key aus der URL

        try {
            const response = await fetch(`get_assignments.php?t=${teamKey}`);
            const data = await response.json();

            if (data.status === 'success') {
                // Entferne alle bestehenden assigned-name Divs
                document.querySelectorAll('.assigned-name').forEach(assignedDiv => assignedDiv.remove());

                // Gehe die Zuordnungen durch und füge sie den entsprechenden Rollen hinzu
                data.assignments.forEach(assignment => {
                    const roleDiv = document.querySelector(`[data-role-key="${assignment.role_key}"]`);

                    if (roleDiv) {
                        const memberDiv = document.createElement('div');
                        memberDiv.classList.add('assigned-name');
                        memberDiv.setAttribute('data-name', assignment.name);
                        memberDiv.setAttribute('data-role', assignment.role_key);
                        memberDiv.innerText = `${assignment.name} (${assignment.count})`;

                        // Markiere, wenn das Mitglied sich selbst zugeordnet hat
                        if (assignment.self_assigned) {
                            memberDiv.classList.add('highlighted');
                        }

                        // Füge das neue Div in die entsprechende Rolle ein
                        roleDiv.appendChild(memberDiv);

                        // Füge den Hover-Event-Listener hinzu
                        addHoverEvents(memberDiv);
                    }
                });
            } else {
                console.error('Fehler beim Abrufen der Zuordnungen:', data.message);
            }
        } catch (error) {
            console.error('Fehler beim Abrufen der Zuordnungen:', error);
        }
    }

    // Fetch members and dynamically create the name divs
    async function fetchAndUpdateMembers(onLoad = false) {
        try {
            const response = await fetch(`get_members.php?t=${teamKey}`);
            const data = await response.json();
            let gotReadyCnt = 0;
            let readyCnt = 0;

            if (data.status === 'success') {
                // Setze Sprache basierend auf dem JSON
                if (onLoad) {
                    if (data.language_code.toLowerCase() === 'en') {
                        translateElements('assignments', 'en');
                    } else {
                        translateElements('assignments', 'de');
                    }
                }

                // Dynamisch die Namens-Divs erstellen oder aktualisieren
                data.members.forEach(member => {
                    let memberDiv = document.querySelector(`div[data-name="${member.name}"]`);
                    if (!memberDiv) {
                        // Neues Div anlegen, falls noch nicht vorhanden
                        memberDiv = document.createElement('div');
                        memberDiv.classList.add('name');
                        memberDiv.setAttribute('data-name', member.name);
                        memberDiv.innerHTML = `
                        <span>${member.name}</span>
                        <i class="fas"></i> <!-- Icon wird dynamisch gesetzt -->
                    `;
                        memberDiv.setAttribute('data-name', member.name);
                        namesAvailableDiv.insertBefore(memberDiv, document.getElementById('backButton'));

                        // Füge den Hover-Event-Listener hinzu
                        addHoverEvents(memberDiv);
                    }
                    if (member.status === 2) readyCnt++;
                    gotReadyCnt += updateMemberStatus(memberDiv, member.status);
                });

                if (readyCnt >= 3) {
                    document.getElementById('overlay').style.display = 'none';

                    if (gotReadyCnt > 0) await updateAssignments();
                }
            }
        } catch (error) {
            console.error('Fehler beim Abrufen der Mitglieder:', error);
        }
    }

    // Funktion zur Aktualisierung des Status eines Mitglieds
    function updateMemberStatus(memberDiv, status) {
        const icon = memberDiv.querySelector('i');
        let gotReady = 0;

        if (status === 0) {
            icon.classList.remove('fa-cog', 'fa-check');
        } else if (status === 1) {
            if (!icon.classList.contains('fa-cog')) {
                icon.classList.add('fa-cog');
            }
            icon.classList.remove('fa-grip-lines', 'fa-check');
        } else if (status === 2) {
            if (!icon.classList.contains('fa-check')) {
                icon.classList.add('fa-check');
                gotReady = 1;
            }
            icon.classList.remove('fa-grip-lines', 'fa-cog');
        }

        return gotReady;
    }

    // Starte die Aktualisierung der Mitglieder alle 2 Sekunden
    setInterval(fetchAndUpdateMembers, 2000);

    // Initial page load
    window.onload = function() {
        fetchAndUpdateMembers(true);

        // Event-Listener für den "Zurück"-Button zur Weiterleitung
        document.getElementById('backButton').addEventListener('click', function() {
            window.location.href = 'base.html?t=' + teamKey;
        });
    };

    // Funktion zum Hervorheben aller Namenselemente
    function highlightNameElements(name) {
        document.querySelectorAll(`[data-name="${name}"]`).forEach(element => {
            element.classList.add('highlight');
        });
    }

    // Funktion zum Entfernen der Hervorhebung
    function removeHighlight() {
        document.querySelectorAll('.highlight').forEach(element => {
            element.classList.remove('highlight');
        });
    }

</script>
</body>
</html>